<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>온라인 체스</title>

  <!-- PeerJS -->
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      text-align: center;
    }

    #top {
      margin-bottom: 10px;
    }

    #status {
      margin: 6px;
      font-weight: bold;
    }

    /* ===== 체스판 전체 레이아웃 ===== */
    #board-area {
      display: inline-grid;
      grid-template-columns: 24px auto;
      grid-template-rows: auto 24px;
      gap: 4px;
      user-select: none;
    }

    /* 왼쪽 숫자 (1~8) */
    #ranks {
      display: grid;
      grid-template-rows: repeat(8, 50px);
      align-items: center;
      justify-items: center;
      font-size: 12px;
      color: #666;
    }

    /* 아래 문자 (A~H) */
    #files {
      grid-column: 2;
      display: grid;
      grid-template-columns: repeat(8, 50px);
      align-items: center;
      justify-items: center;
      font-size: 12px;
      color: #666;
    }

    /* 체스판 */
    #board {
      display: grid;
      grid-template-columns: repeat(8, 50px);
      border: 2px solid #333;
    }

    .cell {
      width: 50px;
      height: 50px;
      font-size: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .white { background: #f0d9b5; }
    .black { background: #b58863; }

    .selected {
      outline: 3px solid red;
      outline-offset: -3px;
    }

    input, button {
      padding: 6px;
      margin: 2px;
    }
  </style>
</head>
<body>

<h1>온라인 체스</h1>

<div id="top">
  <button onclick="createRoom()">방 만들기 (백)</button>
  <input id="roomInput" placeholder="방 코드 입력 (흑)" />
  <button onclick="joinRoom()">입장</button>
  <div id="status">대기 중</div>
</div>

<!-- ===== 체스판 + 좌표 ===== -->
<div id="board-area">
  <div id="ranks"></div>
  <div id="board"></div>
  <div></div>
  <div id="files"></div>
</div>

<script>
/* ===== 네트워크 ===== */
let peer = null;
let conn = null;

let myTurn = false;
let selected = null;

/* ===== 체스 말 ===== */
let board = [
  ["♜","♞","♝","♛","♚","♝","♞","♜"],
  ["♟","♟","♟","♟","♟","♟","♟","♟"],
  ["","","","","","","",""],
  ["","","","","","","",""],
  ["","","","","","","",""],
  ["","","","","","","",""],
  ["♙","♙","♙","♙","♙","♙","♙","♙"],
  ["♖","♘","♗","♕","♔","♗","♘","♖"]
];

const boardEl = document.getElementById("board");
const ranksEl = document.getElementById("ranks");
const filesEl = document.getElementById("files");
const statusEl = document.getElementById("status");

/* ===== 좌표 ===== */
function drawCoords() {
  ranksEl.innerHTML = "";
  filesEl.innerHTML = "";

  for (let i = 8; i >= 1; i--) {
    const d = document.createElement("div");
    d.textContent = i;
    ranksEl.appendChild(d);
  }

  for (let c = 0; c < 8; c++) {
    const d = document.createElement("div");
    d.textContent = String.fromCharCode(65 + c);
    filesEl.appendChild(d);
  }
}

/* ===== 보드 렌더 ===== */
function drawBoard() {
  boardEl.innerHTML = "";
  for (let r = 0; r < 8; r++) {
    for (let c = 0; c < 8; c++) {
      const cell = document.createElement("div");
      cell.className = "cell " + ((r + c) % 2 === 0 ? "white" : "black");
      cell.textContent = board[r][c];
      if (selected && selected.r === r && selected.c === c) {
        cell.classList.add("selected");
      }
      cell.onclick = () => clickCell(r, c);
      boardEl.appendChild(cell);
    }
  }
}

/* ===== 클릭 ===== */
function clickCell(r, c) {
  if (!myTurn) return;

  if (!selected) {
    if (!board[r][c]) return;
    selected = { r, c };
  } else {
    board[r][c] = board[selected.r][selected.c];
    board[selected.r][selected.c] = "";
    selected = null;
    myTurn = false;
    sendState();
  }
  drawBoard();
}

/* ===== 통신 ===== */
function sendState() {
  if (conn) conn.send(board);
}

function setupConnection() {
  conn.on("data", data => {
    board = data;
    myTurn = true;
    drawBoard();
  });
}

/* ===== 방 생성 ===== */
function createRoom() {
  peer = new Peer();
  peer.on("open", id => {
    statusEl.textContent = "방 코드: " + id + " (백)";
    myTurn = true;
  });

  peer.on("connection", c => {
    conn = c;
    setupConnection();
  });
}

/* ===== 방 입장 ===== */
function joinRoom() {
  const id = document.getElementById("roomInput").value.trim();
  if (!id) return;

  peer = new Peer();
  peer.on("open", () => {
    conn = peer.connect(id);
    statusEl.textContent = "입장 완료 (흑)";
    myTurn = false;
    setupConnection();
  });
}

/* ===== 시작 ===== */
drawCoords();
drawBoard();
</script>

</body>
</html>
