<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>온라인 체스</title>

  <!-- PeerJS -->
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      text-align: center;
    }

    #top {
      margin-bottom: 10px;
    }

    #status {
      margin: 6px;
      font-weight: bold;
    }

    #board-wrapper {
      display: inline-block;
    }

    #files {
      display: grid;
      grid-template-columns: repeat(8, 50px);
      margin-left: 30px;
      font-size: 14px;
    }

    #ranks {
      display: grid;
      grid-template-rows: repeat(8, 50px);
      margin-top: 20px;
      font-size: 14px;
      float: left;
    }

    #board {
      display: grid;
      grid-template-columns: repeat(8, 50px);
      border: 2px solid #333;
    }

    .rank, .file {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .cell {
      width: 50px;
      height: 50px;
      font-size: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .white {
      background: #f0d9b5;
    }

    .black {
      background: #b58863;
    }

    .selected {
      outline: 3px solid red;
    }

    input, button {
      padding: 6px;
      margin: 2px;
    }
  </style>
</head>
<body>

<h1>온라인 체스</h1>

<div id="top">
  <button onclick="createRoom()">방 만들기 (백)</button>
  <input id="roomInput" placeholder="방 코드 입력 (흑)" />
  <button onclick="joinRoom()">입장</button>
  <div id="status">대기 중</div>
</div>

<div id="board-wrapper">
  <div id="ranks"></div>
  <div id="board"></div>
  <div style="clear: both;"></div>
  <div id="files"></div>
</div>

<script>
/* ====== 기본 상태 ====== */
let peer = null;
let conn = null;

let myColor = null; // "white" | "black"
let myTurn = false;
let selected = null;

/* ====== 표준 체스 말 ====== */
const PIECES = {
  white: ["♖","♘","♗","♕","♔","♗","♘","♖","♙"],
  black: ["♜","♞","♝","♛","♚","♝","♞","♜","♟"]
};

/* ====== 보드 ====== */
let board = [
  ["♜","♞","♝","♛","♚","♝","♞","♜"],
  ["♟","♟","♟","♟","♟","♟","♟","♟"],
  ["","","","","","","",""],
  ["","","","","","","",""],
  ["","","","","","","",""],
  ["","","","","","","",""],
  ["♙","♙","♙","♙","♙","♙","♙","♙"],
  ["♖","♘","♗","♕","♔","♗","♘","♖"]
];

const boardEl = document.getElementById("board");
const statusEl = document.getElementById("status");

/* ====== 좌표 ====== */
function drawCoords() {
  const ranks = document.getElementById("ranks");
  const files = document.getElementById("files");
  ranks.innerHTML = "";
  files.innerHTML = "";

  for (let i = 8; i >= 1; i--) {
    const d = document.createElement("div");
    d.className = "rank";
    d.textContent = i;
    ranks.appendChild(d);
  }

  for (let c = 0; c < 8; c++) {
    const d = document.createElement("div");
    d.className = "file";
    d.textContent = String.fromCharCode(65 + c);
    files.appendChild(d);
  }
}

/* ====== 보드 렌더 ====== */
function drawBoard() {
  boardEl.innerHTML = "";
  for (let r = 0; r < 8; r++) {
    for (let c = 0; c < 8; c++) {
      const cell = document.createElement("div");
      cell.className = "cell " + ((r + c) % 2 === 0 ? "white" : "black");
      cell.textContent = board[r][c];
      if (selected && selected.r === r && selected.c === c) {
        cell.classList.add("selected");
      }
      cell.onclick = () => clickCell(r, c);
      boardEl.appendChild(cell);
    }
  }
}

/* ====== 클릭 ====== */
function clickCell(r, c) {
  if (!myTurn) return;

  if (!selected) {
    if (!board[r][c]) return;
    selected = { r, c };
  } else {
    board[r][c] = board[selected.r][selected.c];
    board[selected.r][selected.c] = "";
    selected = null;
    myTurn = false;
    sendState();
  }
  drawBoard();
}

/* ====== 네트워크 ====== */
function sendState() {
  if (conn) conn.send(board);
}

function setupConnection() {
  conn.on("data", data => {
    board = data;
    myTurn = true;
    drawBoard();
  });
}

/* ====== 방 생성 ====== */
function createRoom() {
  peer = new Peer();
  peer.on("open", id => {
    statusEl.textContent = "방 코드: " + id + " (백)";
    myColor = "white";
    myTurn = true;
  });

  peer.on("connection", c => {
    conn = c;
    setupConnection();
  });
}

/* ====== 방 입장 ====== */
function joinRoom() {
  const id = document.getElementById("roomInput").value.trim();
  if (!id) return;

  peer = new Peer();
  peer.on("open", () => {
    conn = peer.connect(id);
    statusEl.textContent = "입장 완료 (흑)";
    myColor = "black";
    myTurn = false;
    setupConnection();
  });
}

/* ====== 시작 ====== */
drawCoords();
drawBoard();
</script>

</body>
</html>
