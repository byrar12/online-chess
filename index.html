<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>온라인 체스</title>
  <style>
    body { font-family: Arial; text-align: center; }
    #board {
      display: grid;
      grid-template-columns: repeat(8, 50px);
      width: 400px;
      margin: 20px auto;
    }
    .cell {
      width: 50px;
      height: 50px;
      font-size: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .white { background: #f0d9b5; }
    .black { background: #b58863; }
    .selected { outline: 3px solid red; }
  </style>
</head>
<body>

<h1>온라인 체스</h1>

<div>
  <button onclick="createRoom()">방 만들기</button>
  <input id="roomId" placeholder="방 코드 입력" />
  <button onclick="joinRoom()">입장</button>
</div>

<p id="status">대기 중...</p>

<div id="board"></div>

<!-- PeerJS -->
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<script>
const boardEl = document.getElementById("board");
const statusEl = document.getElementById("status");

let peer = null;
let conn = null;

let selected = null;
let myTurn = false;
let isHost = false;

// 말 배치 (불법 수 허용)
let board = [
  "♜♞♝♛♚♝♞♜",
  "♟♟♟♟♟♟♟♟",
  "........",
  "........",
  "........",
  "........",
  "♙♙♙♙♙♙♙♙",
  "♖♘♗♕♔♗♘♖"
];

function draw() {
  boardEl.innerHTML = "";
  for (let r = 0; r < 8; r++) {
    for (let c = 0; c < 8; c++) {
      const i = r * 8 + c;
      const cell = document.createElement("div");
      cell.className = "cell " + ((r + c) % 2 ? "black" : "white");
      cell.textContent = board[r][c] === "." ? "" : board[r][c];
      if (selected === i) cell.classList.add("selected");
      cell.onclick = () => clickCell(i);
      boardEl.appendChild(cell);
    }
  }
}

function clickCell(i) {
  if (!myTurn) return;

  if (selected === null) {
    selected = i;
  } else {
    move(selected, i);
    selected = null;
  }
  draw();
}

function move(from, to) {
  const fr = Math.floor(from / 8);
  const fc = from % 8;
  const tr = Math.floor(to / 8);
  const tc = to % 8;

  const piece = board[fr][fc];
  if (piece === ".") return;

  board[fr] = replace(board[fr], fc, ".");
  board[tr] = replace(board[tr], tc, piece);

  send();
  myTurn = false;
}

function replace(str, idx, ch) {
  return str.substring(0, idx) + ch + str.substring(idx + 1);
}

function send() {
  if (conn) conn.send(board);
}

function createRoom() {
  peer = new Peer();
  peer.on("open", id => {
    statusEl.textContent = "방 코드: " + id + " (공유하세요)";
    isHost = true;
    myTurn = true;

    peer.on("connection", c => {
      conn = c;
      conn.on("data", data => {
        board = data;
        myTurn = true;
        draw();
      });
    });
  });
}

function joinRoom() {
  const id = document.getElementById("roomId").value.trim();
  peer = new Peer();
  peer.on("open", () => {
    conn = peer.connect(id);
    conn.on("open", () => {
      statusEl.textContent = "입장 완료";
      myTurn = false;
    });
    conn.on("data", data => {
      board = data;
      myTurn = true;
      draw();
    });
  });
}

draw();
</script>

</body>
</html>
